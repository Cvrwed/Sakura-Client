package cc.unknown.module.impl.exploit;

import cc.unknown.event.Listener;
import cc.unknown.event.annotations.EventLink;
import cc.unknown.event.impl.netty.PacketEvent;
import cc.unknown.event.impl.other.TeleportEvent;
import cc.unknown.module.Module;
import cc.unknown.module.api.Category;
import cc.unknown.module.api.ModuleInfo;
import cc.unknown.value.impl.ModeValue;
import cc.unknown.value.impl.SubMode;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;

/**
 * @author Auth
 * @since 3/02/2022
 */

@ModuleInfo(aliases = "No Rotate", description = "Prevents servers from modifying your view angles", category = Category.EXPLOIT)
public class NoRotate extends Module {

    private final ModeValue mode = new ModeValue("Mode", this)
            .add(new SubMode("Cancel"))
            .add(new SubMode("Edit"))
            .setDefault("Edit");
    
    private float yaw, pitch;
    private boolean teleport;
    
    @EventLink
    public final Listener<TeleportEvent> onTeleport = event -> {
    	if (mode.is("Cancel")) {
	        event.setYaw(mc.player.rotationYaw);
	        event.setPitch(mc.player.rotationPitch);
    	}
    	
    	if (mode.is("Edit")) {
            this.yaw = event.getYaw();
            this.pitch = event.getPitch();

            event.setYaw(mc.player.rotationYaw);
            event.setPitch(mc.player.rotationPitch);

            this.teleport = true;
    	}
    };
    
    @EventLink
    public final Listener<PacketEvent> onPacketSend = event -> {
        final Packet packet = event.getPacket();

        if (event.isReceive()) {
	        if (mode.is("Edit")) {
		        if (this.teleport && packet instanceof C03PacketPlayer.C06PacketPlayerPosLook) {
		            final C03PacketPlayer.C06PacketPlayerPosLook c06PacketPlayerPosLook = ((C03PacketPlayer.C06PacketPlayerPosLook) packet);
		
		            c06PacketPlayerPosLook.yaw = this.yaw;
		            c06PacketPlayerPosLook.pitch = this.pitch;
		
		            event.setPacket(c06PacketPlayerPosLook);
		
		            this.teleport = false;
		        }
	        }
        }
    };
}